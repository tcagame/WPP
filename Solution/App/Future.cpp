#include "Drawer.h"
#include "Future.h"
#include "Item.h"
#include "Past.h"
#include "define.h"

const double ROT_SPEED = 0.025;
const int SHEET_NUM = 6;
const int ITEM_GET_RENGE = 16;

const char DATA[ SHEET_NUM ][ ORIGINAL_NUM * ORIGINAL_NUM + 1 ] = {
{//0
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                 *********************************************                                      "
"                 **********************************************                                     "
"                 **************************************************                                 "
"                 ****************************************************                               "
"                 *******************************************************                            "
"                 *************************************                                              "
"                 ***********************************                                                "
"                 ******************************************                                         "
"                 *************************************                                              "
"                 **********************************                                                 "
"                 **********************************************                                     "
"                 ****************************************                                           "
"                 ****************************************                                           "
"                 ***************************************                                            "
"                 ****************************************                                           "
"                 ******************************************                                         "
"                 *****************************************                                          "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
},
{//1
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                 **********************************************************         "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                              $                                                     "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                              *                *                *                                   "
"                              *                *                *                                   "
"                              *                *                *                                   "
"                              *                *                *                                   "
"                             ***              ***              ***                                  "
"                            *****            *****            *****                                 "
"                          *********        *********        *********                               "
"                         ***********      ***********      ***********                              "
"                        *************    *************    *************                             "
"***                    ***** *** *****  ***** *** *****  ***** *** *****                            "
" ***                   **** * * * ****  **** * * * ****  **** * * * ****                            "
"  ***                  **** * * * ****  **** * * * ****  **** * * * ****                            "
"                       ** ** *** ** **  ** ** *** ** **  ** ** *** ** **                            "
"                       **  *******  **  **  *******  **  **  *******  **                            "
"                        **         **    **         **    **         **                             "
"                         ***********      ***********      ***********                              "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"         **************************************************************                             "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
},
{//2
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                 **********************************************************         "
"                                                                                                    "
"                                              *                                                     "
"                                              *                                                     "
"                                              *                                                     "
"                                              *                                                     "
"                                             ***                                                    "
"                                            *****                                                   "
"                                          *********                                                 "
"                                         ***********                                                "
"                                        *************                                               "
"                                       ***** *** *****                                              "
"                                       **** * * * ****                                              "
"                                       **** * * * ****                                              "
"                                       ** ** *** ** **                        $                     "
"                                       **  *******  **                                              "
"                                        **         **                                               "
"                                         ***********                                                "
"                                             ***                                                    "
"                                            *****                                                   "
"                                          *********                                                 "
"                                         ***********                                                "
"                                        *************                                               "
"                                       ***** *** *****                                              "
"                                       **** * * * ****                                              "
"                                       **** * * * ****                                              "
"                                       ** ** *** ** **                                              "
"                                       **  *******  **                                              "
"                                        **         **                                               "
"                                         ***********                                                "
"                                             ***                                                    "
"                                            *****                                                   "
"                                          *********                                                 "
"                                         ***********                                                "
"                                        *************                                               "
"                                       ***** *** *****                                              "
"                                       **** * * * ****                                              "
"                                       **** * * * ****                                              "
"                                       ** ** *** ** **                                              "
"                                       **  *******  **                                              "
"                                        **         **                                               "
"                                         ***********                                                "
"                                                                                                    "
"                                                                                                    "
"         **************************************************************                             "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
},
{//3
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                 **********************************************************         "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                              $                                                     "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                              *                                                     "
"                                              *                                                     "
"                                              *                                                     "
"                                              *                                                     "
"                                             ***                                                    "
"                                            *****                                                   "
"                                          *********                                                 "
"                                         ***********                                                "
"                                        *************                                               "
"***                                    ***** *** *****                                              "
" ***                                   **** * * * ****                                              "
"  ***                                  **** * * * ****                                              "
"                                       ** ** *** ** **                                              "
"                                       **  *******  **                                              "
"                                        **         **                                               "
"                                         ***********                                                "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"         **************************************************************                             "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
},
{//4
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                 **********************************************************         "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                              $                                                     "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                              *                *                *                                   "
"                              *                *                *                                   "
"                              *                *                *                                   "
"                              *                *                *                                   "
"                             ***              ***              ***                                  "
"                            *****            *****            *****                                 "
"                          *********        *********        *********                               "
"                         ***********      ***********      ***********                              "
"                        *************    *************    *************                             "
"***                    ***** *** *****  ***** *** *****  ***** *** *****                            "
" ***                   **** * * * ****  **** * * * ****  **** * * * ****                            "
"  ***                  **** * * * ****  **** * * * ****  **** * * * ****                            "
"                       ** ** *** ** **  ** ** *** ** **  ** ** *** ** **                            "
"                       **  *******  **  **  *******  **  **  *******  **                            "
"                        **         **    **         **    **         **                             "
"                         ***********      ***********      ***********                              "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"         **************************************************************                             "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
},
{//5
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                 **********************************************************         "
"                                                                                                    "
"                                              *                                                     "
"                                              *                                                     "
"                                              *                                                     "
"                                              *                                                     "
"                                             ***                                                    "
"                                            *****                                                   "
"                                          *********                                                 "
"                                         ***********                                                "
"                                        *************                                               "
"                                       ***** *** *****                                              "
"                                       **** * * * ****                                              "
"                                       **** * * * ****                                              "
"                                       ** ** *** ** **                        $                     "
"                                       **  *******  **                                              "
"                                        **         **                                               "
"                                         ***********                                                "
"                                             ***                                                    "
"                                            *****                                                   "
"                                          *********                                                 "
"                                         ***********                                                "
"                                        *************                                               "
"                                       ***** *** *****                                              "
"                                       **** * * * ****                                              "
"                                       **** * * * ****                                              "
"                                       ** ** *** ** **                                              "
"                                       **  *******  **                                              "
"                                        **         **                                               "
"                                         ***********                                                "
"                                             ***                                                    "
"                                            *****                                                   "
"                                          *********                                                 "
"                                         ***********                                                "
"                                        *************                                               "
"                                       ***** *** *****                                              "
"                                       **** * * * ****                                              "
"                                       **** * * * ****                                              "
"                                       ** ** *** ** **                                              "
"                                       **  *******  **                                              "
"                                        **         **                                               "
"                                         ***********                                                "
"                                                                                                    "
"                                                                                                    "
"         **************************************************************                             "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
"                                                                                                    "
}
};







Future::Future( PastPtr past ) :
_past( past ),
_rot( 0 ),
_sheet( 1 ){
	DrawerPtr drawer = Drawer::getTask( );
	drawer->createGraph( GRAPH_SCREEN_FUTURE, PAINTING_SIZE, PAINTING_SIZE );
	drawer->loadGraph( GRAPH_FUTURE_DOT_1, "future_dot_1.png" );
	drawer->loadGraph( GRAPH_FUTURE_DOT_2, "future_dot_2.png" );
	drawer->loadGraph( GRAPH_ITEM, "item.png" );
	for ( int i = 0; i <  ORIGINAL_NUM * ORIGINAL_NUM; i++ ) {
		_data[ i ] = DATA[ _sheet ][ i ];
	}
	load( );
}


Future::~Future( ) {
}

GRAPH Future::getGraph( ) const {
	return GRAPH_SCREEN_FUTURE;
}

void Future::update( ) {
	//_rot += ROT_SPEED;
	Matrix mat = Matrix::makeTransformRotation( Vector( 0, 0, 1 ), _rot );

	char tmp[ ORIGINAL_NUM * ORIGINAL_NUM ] = { 0 };
	for ( int i = 0; i < ORIGINAL_NUM; i++ ) {
		for ( int j = 0; j < ORIGINAL_NUM; j++ ) {
			Vector vec( i, j );

			// SxNg
			vec = vec - Vector( ORIGINAL_NUM / 2, ORIGINAL_NUM / 2 );
			// ]
			vec = mat.multiply( vec );
			// _xNg
			vec = vec + Vector( ORIGINAL_NUM / 2, ORIGINAL_NUM / 2 );

			int xx = ( int )vec.x;
			int yy = ( int )vec.y;

			char ch = ' ';
			if ( xx >= 0 && xx < ORIGINAL_NUM &&
				 yy >= 0 && yy < ORIGINAL_NUM ) {
				int data_idx = xx + yy * ORIGINAL_NUM;
				ch = _data[ data_idx ];
			}

			int tmp_idx = i + j * ORIGINAL_NUM;
			tmp[ tmp_idx ] = ch;
		}
	}	

	// `
	DrawerPtr drawer = Drawer::getTask( );
	drawer->clearToGraph( GRAPH_SCREEN_FUTURE );
	if ( _sheet >= SHEET_NUM ) {
		return;
	}
	for ( int i = 0; i < DOT_NUM; i += 2 ) {
		for ( int j = 0; j < DOT_NUM; j += 2 ) {

			int xx = i + ( ORIGINAL_NUM - DOT_NUM ) / 2;
			int yy = j + ( ORIGINAL_NUM - DOT_NUM ) / 2;
			GRAPH graph = GRAPH_FUTURE_DOT_1;
			int idx = yy * ORIGINAL_NUM + xx;
			if ( tmp[ idx ] == '*' ) {
				graph = GRAPH_FUTURE_DOT_2;
			}

			unsigned char flg = 0;

			const int OFFSET_X[ 8 ] = { -1,  1, -1, 1,  0,  0, -1,  1 };
			const int OFFSET_Y[ 8 ] = { -1, -1,  1, 1, -1,  1,  0,  0 };

			for ( int k = 0; k < 8; k++ ) {
				int idx = ( xx + OFFSET_X[ k ] ) + ( yy + OFFSET_Y[ k ] ) * ORIGINAL_NUM;
				flg |= ( tmp[ idx ] == '*' ) << k;
			}
			
			int x = i * DOT_SIZE - DOT_SIZE / 4;
			int y = j * DOT_SIZE - DOT_SIZE / 4;
			Drawer::Transform trans( x, y, ( flg % 16 ) * DOT_SIZE * 2, ( flg / 16 ) * DOT_SIZE * 2, DOT_SIZE * 2, DOT_SIZE * 2 );
			Drawer::Sprite sprite( trans, graph );
			drawer->drawSpriteToGraph( GRAPH_SCREEN_FUTURE, sprite );
		}
	}
	
	if ( _item ) {
		Matrix mat = Matrix::makeTransformRotation( Vector( 0, 0, -1 ), _rot );
		_item->update( mat, ORIGINAL_NUM );
	}
}

void Future::load( ) {
	_item = ItemPtr( );
	if ( _sheet >= SHEET_NUM ) {
		return;
	}
	for ( int i = 0; i < ORIGINAL_NUM * ORIGINAL_NUM; i++ ) {
		if ( DATA[ _sheet ][ i ] == '$' ) {
			int x = i % ORIGINAL_NUM;
			int y = i / ORIGINAL_NUM;
			_item = ItemPtr( new Item( Vector( x, y ) ) );
		}
	}
}

void Future::change( ) {
	char data[ DOT_NUM * DOT_NUM + 1 ];
	DrawerPtr drawer = Drawer::getTask( );

	for ( int i = 0; i < DOT_NUM; i++ ) {
		for ( int j = 0; j < DOT_NUM; j++ ) {
			//@]
			Vector vec(
				i - DOT_NUM / 2,
				j - DOT_NUM / 2 );
			Matrix mat = Matrix::makeTransformRotation( Vector( 0, 0, 1 ), _rot );
			vec = mat.multiply( vec );
			int xx = ( int )vec.x + ORIGINAL_NUM / 2;
			int yy = ( int )vec.y + ORIGINAL_NUM / 2;
			int idx = xx + yy * ORIGINAL_NUM;
			if ( _data[ idx ] == '*' ) {
				data[ i + j * DOT_NUM ] = '*';
			}
		}
	}
	_past->addPicture( data );
	_sheet++;
	for ( int i = 0; i <  ORIGINAL_NUM * ORIGINAL_NUM; i++ ) {
		_data[ i ] = DATA[ _sheet ][ i ];
	}
	load( );
}

bool Future::isErase( Vector pos, double radius ) {
	pos.y -= radius;
	radius += 1;
	//G]@posu af[^
	//@]
	Vector vec(
		(int)pos.x - DOT_NUM / 2,
		(int)pos.y - DOT_NUM / 2 );
	Matrix mat = Matrix::makeTransformRotation( Vector( 0, 0, 1 ), _rot );
	vec = mat.multiply( vec );
	int xx = ( int )vec.x + ORIGINAL_NUM / 2;
	int yy = ( int )vec.y + ORIGINAL_NUM / 2;
	for ( int i = 0; i < radius; i++ ) {
		double height = (int)( sqrt( radius * radius - i * i ) );
		for ( int j = 0; j < height; j++ ) {
			//E
			int x = xx + i;
			int y = yy + j;
			int idx = x + y * ORIGINAL_NUM;
			_data[ idx ] = ' ';

			//E
			y = yy - j;
			idx = x + y * ORIGINAL_NUM;
			_data[ idx ] = ' ';

			//
			x = xx - i;
			idx = x + y * ORIGINAL_NUM;
			_data[ idx ] = ' ';

			//
			x = xx - i;
			y = yy + j;
			idx = x + y * ORIGINAL_NUM;
			_data[ idx ] = ' ';
		}
	}
	return true;
}

bool Future::isGetItem( Vector pos ) {
	if ( !_item ) {
		return false;
	}

	if ( ( _item->getPos( ) - pos ).getLength( ) <= ITEM_GET_RENGE ) {
		_item.reset( );
		return true;
	}
}